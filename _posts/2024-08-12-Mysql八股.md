---
title: Mysql八股
date: 2024-08-12 16:43:00 +0800
categories: [学习, 八股]
tags: [八股]
---

## 一. 一条SQL查询语句是如何执行的
### 连接器
* 第一步肯定是要先连接 MySQL 服务，然后才能执行 SQL 语句。连接的过程需要先经过 TCP 三次握手，因为 MySQL 是基于 TCP 协议进行传输的，完成 TCP 连接的建立后，连接器就要开始验证你的用户名和密码，通过验证就会读取该用户的权限，然后后面的权限逻辑判断都基于此时读取到的权限。
* 空闲连接若是空闲超过了wait_timeout参数控制的时间，连接器就会自动将它断开。
* MySQL服务支持的最大连接数由 max_connections 参数控制。
* 使用长连接的好处就是可以减少建立连接和断开连接的过程，一般是使用长连接，但如果如果长连接累计很多，将导致 MySQL 服务占用内存太大，有可能会被系统强制杀掉，这样会发生 MySQL 服务异常重启的现象。
* 定期断开长连接，或是客户端主动重置连接，调用mysql_reset_connection() 函数的接口不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态，释放内存。

### 查询缓存
* 如果 SQL 是查询语句，MySQL 就会先去查询缓存，这个查询缓存是以 key-value 形式保存在内存中的，key 为 SQL 查询语句，value 为 SQL 语句查询的结果。
* 这个缓存只要表更新就会被清空，命中率很低，后面版本直接删掉这个部分了。

### 解析SQL
由Mysql的解析器进行操作。
* 词法分析，MySQL 会根据你输入的字符串识别出关键字出来。
* 语法分析，根据词法分析的结果，语法解析器会根据语法规则，构建出 SQL 语法树，供后续执行。

### 执行SQL
1. 预处理器
* 负责检查 SQL 查询语句中的表或者字段是否存在；将 select * 中的 * 符号，扩展为表上的所有列；
2. 优化器
* 为 SQL 查询语句先制定一个执行计划，比如在表里面有多个索引的时候，优化器会基于查询成本的考虑，来决定选择使用哪个索引。
3. 执行器
* 在执行的过程中，执行器就会和存储引擎交互了，交互是以记录为单位的，最后将结果返回给客户端。

## 二. 数据库的事务隔离级别有哪些
1. 读未提交（read uncommitted），指一个事务还没提交时，它做的变更就能被其他事务看到；可能发生脏读、不可重复读和幻读现象；
2. 读提交（read committed），指一个事务提交之后，它做的变更才能被其他事务看到；可能发生不可重复读和幻读现象，但是不可能发生脏读现象；
3. 可重复读（repeatable read），指一个事务执行过程中看到的数据，一直跟这个事务启动时看到的数据是一致的，MySQL InnoDB 引擎的默认隔离级别；可能发生幻读现象，但是不可能脏读和不可重复读现象；
4. 串行化（serializable ）；会对记录加上读写锁，在多个事务对这条记录进行读写操作时，如果发生了读写冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行；脏读、不可重复读和幻读现象都不可能会发生。

## 三. 事务的四大特性有哪些
1. 原子性（Atomicity）：一个事务中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节，而且事务在执行过程中发生错误，会被回滚到事务开始前的状态。通过 undo log（回滚日志）来保证；
2. 一致性（Consistency）：是指事务操作前和操作后，数据满足完整性约束，数据库保持一致性状态。通过持久性+原子性+隔离性来保证。
3. 隔离性（Isolation）：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。通过MVCC（多版本并发控制） 或锁机制来保证。
4. 持久性（Durability）：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。通过 redo log （重做日志）来保证。