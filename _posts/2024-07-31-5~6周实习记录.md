---
title: 5~6周实习记录
date: 2024-07-31 9:10:00 +0800
categories: [工作, 实习]
tags: [实习]
---

来这里实习也快一个月了，给我们三个新员工分配了第一个需求，感觉还是有点难度的，流程图那里是没有接触过的Apache Camel框架，需要时间去理解。

## 需求描述
我们要针对单个应用流程构建出**系统--应用--厂家--连接器节点**的拓扑图，图要能够反映出流程的执行情况，正常运行标绿；未运行标灰；运行出错标红，将状态写入Redis，同时在出错和恢复正常时要将提示信息放入消息队列，起到通知的作用。

具体一些：

1. 为了方便直观地展示青鸾与其他系统之间的调用关系和通信状态，在系统监控-拓扑监控菜单下自动绘制拓扑和状态
2. 拓扑图共四层：青鸾-应用-厂家-接口；接口节点为应用中的连接器节点
3. 节点形状、描边、颜色按照样图颜色配置
4. 链路颜色：应用运行状态且接口正常为绿色、应用运行状态且接口中断为红色、应用配置状态为灰色；根链路颜色根据叶子链路颜色的最优颜色展示；优先级：灰色>绿色>红色
5. 接口由正常调用转为异常时，向kafka写入接口异常数据；接口由异常调用转为正常时，向kafka写入接口恢复数据；接口异常时，并将应用置为“配置中”状态时，也需向kafka写入接口恢复数据，且将链路置为灰色
6. 链路状态判断粒度为应用中的连接器节点

## 初步方案
想法是分为两大步，首先实现拓扑图构造，再实现关系。
### 一. 拓扑图构造
1. 我们于connector_flow表中可以首先获取到所有的应用流程信息，可以构建出第一层**系统--应用**的拓扑。
2. 应用流程都有一个全局唯一的id，在connector_flow_node中我们可以通过connector_flow_id字段获取该流程下的节点信息，根据其connector_instance_id查到厂家信息，可以构建出第二层**应用--厂家**的拓扑。
3. 这些节点除去触发器和逻辑判断节点，其信息都会包含connector_model_id字段和connector_instance_id字段，根据前者我们可以获取是哪种连接器，根据后者我们可以查到实例的信息比如IP、端口、超时时间等信息，可以构建出第三层**厂家--连接器节点**的拓扑。  

补充：
* 以上汇总成一个拓扑图构造的接口，要考虑返回json数据结构的设计。
* 还需要一个保存拓扑图的接口，要进行保存拓扑图坐标的表结构设计。（暂时搁置）

### 二. 关系实现
这部分我想首先实现状态的区分，要求应用流程配置中全线标灰、正常运行标绿、出错标红，优先级灰色>绿色>红色；状态能够区分后再去把消息写入kafka，消息要求三种：*1.接口由正常调用转为异常时，向kafka写入接口异常数据 2.接口由异常调用转为正常时，向kafka写入接口恢复数据 3.接口异常时，并将应用置为“配置中”状态时，也需向kafka写入接口恢复数据，且将链路置为灰色。*  

前提条件：进行状态判断是在运行该流程时进行的。

1. 状态区分  
* 首先考虑存储Redis的key，定义常量**NODE_STATUS_KEY = "node_status:"** ，节点包含所处应用流程的信息，采用**NODE_STATUS_KEY + 连接器节点ID**就可以进行区分。以value值做状态的区分，-1为出错，0为配置中，1为正常运行，所以用String类型就可以实现功能。
* 应用流程创建出的时候应当默认为灰色，但是创建时并没有把状态写入Redis，我们考虑在Redis中查不到节点对应键值对的时候就默认为灰色。创建完毕后，发布流程时就写入Redis，value为1，目的是让发布后流程未被触发时默认为绿色，之后运行成功value改为1，失败catch到异常改为-1，取消发布要将所有节点的更改为0。
* 然后还需要一个判断节点状态的接口，传入连接器节点ID，在Redis中查，返回value值，前端根据前面的约定再做判断。  

2. 消息队列
* 接口由正常调用转为异常时：handleRouterConnector在catch到异常时，将接口异常数据写入kafka。
* 接口由异常调用转为正常时：handleRouterConnector没有catch到异常时，将接口恢复数据写入kafka。
* 接口异常，并将应用置为“配置中”状态时：在取消发布时，若此时应用对应的Redis节点状态有为-1的，要向kafka写入接口恢复数据。

补充：
* 对于发布和取消发布的实现部分要在消息消费时进行处理。
* 需要定以上消息的topic和内容。

## 流程图

## 详细设计
### 一. 拓扑图JSON数据结构设计
目标是要分出系统-应用-厂家-节点四个层次。首先查出所有应用流程，以应用流程名称为JSON第一层结构；遍历查出的应用流程，根据其id依次去查对应的连接器节点的实例id，根据实例id查到厂家名称构建出第二层JSON结构；再用实例id和应用流程id查对应连接器节点作为第三层JSON结构。
### 二. 拓扑图坐标表结构设计
看前端需求

## 后端接口
### 1. 拓扑图构建
#### 1.1 基本信息
> 请求路径：/connect/getTop
>
> 请求方式：GET
>
> 接口描述：该接口用于返回构建拓扑图所需信息
#### 1.2 请求参数
无
#### 1.3 响应数据
参数格式：application/json  

响应数据样例：
``` json

```
### 2. 节点状态判断
#### 2.1 基本信息
> 请求路径：/connect/getNodeStatus  
>
> 请求方式：GET  
>
> 接口描述：该接口用于判断单个节点的状态  
#### 2.2 请求参数
参数格式：路径参数

参数说明：

| 参数名 | 类型   | 是否必须 | 备注   |
| ------ | ------ | -------- | ------ |
| id     | String | 必须     | 节点ID |

请求参数样例：

```
/connect/getNodeStatus/28a2483b-b7a7-487a-a077-15c9c1121e19
```
#### 2.3 响应数据
参数格式：application/json  

响应数据样例：
``` json

```